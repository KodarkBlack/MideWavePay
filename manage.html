<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MideWave - Dashboard</title>
    <!-- Preload critical resources -->
    <link rel="preload" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" as="style">
    <link rel="icon" href="/assets/mountain-goat.PNG" type="image/png">

    <!-- CSS -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6b6b;
            --text-dark: #343a40;
            --text-light: #f8f9fa;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--text-dark);
            padding-top: 60px;
            min-height: 100vh;
        }

        .navbar {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white !important;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }

        .nav-link {
            font-weight: 500;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .balance {
            background: linear-gradient(135deg, var(--primary-color), #6c5ce7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance b {
            font-size: 1.2rem;
        }

        .balance span {
            font-weight: 700;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .deposit-btn {
            background-color: var(--success-color);
            color: white;
        }

        .withdraw-btn {
            background-color: var(--accent-color);
            color: white;
        }

        .action-buttons button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .services {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 80px;
        }

        .services button {
            background-color: white;
            border: none;
            padding: 20px;
            border-radius: 10px;
            font-weight: 600;
            color: var(--text-dark);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .services button:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background-color: var(--primary-color);
            color: white;
        }

        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item-manage {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .nav-item-manage i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        a {
            text-decoration: none;
        }

        a.active .nav-item-manage {
            color: var(--primary-color);
        }

        /* Modal styles */
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .modal {
            /* Fix for aria-hidden warning */
            transition: none !important;
        }

        /* Ensure modal is properly hidden when not shown */
        .modal:not(.show) {
            display: none !important;
        }

        .modal-header {
            border-bottom: none;
            padding-bottom: 0;
        }

        .modal-title {
            font-weight: 700;
            color: var(--primary-color);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 107, 255, 0.25);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: #3a5bef;
        }

        /* Custom Alert Modal */
        .alert-modal .modal-dialog {
            max-width: 400px;
        }

        .alert-modal .modal-content {
            border-radius: 12px;
        }

        .alert-modal .modal-header {
            border-bottom: none;
            padding-bottom: 0;
            justify-content: center;
        }

        .alert-modal .modal-title {
            font-size: 1.5rem;
            text-align: center;
        }

        .alert-modal .modal-body {
            text-align: center;
            padding: 20px 30px;
        }

        .alert-modal .modal-footer {
            border-top: none;
            justify-content: center;
            padding-top: 0;
        }

        .alert-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .success-icon {
            color: var(--success-color);
        }

        .error-icon {
            color: var(--error-color);
        }

        .warning-icon {
            color: #ffc107;
        }

        .info-icon {
            color: var(--primary-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .balance {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .services {
                grid-template-columns: 1fr 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .services {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding: 15px 10px;
                gap: 15px;
            }

            .navbar-brand {
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <a class="navbar-brand" href="#">MideWave</a>
    </nav>

    <div class="dashboard">
        <div class="balance">
            <b>Welcome <span id="username">User</span></b>
            <b>Balance: $<span id="balance">0.00</span></b>
        </div>

        <div class="action-buttons">
            <button class="deposit-btn" onclick="showDepositModal()">
                <i class='bx bx-credit-card' style="margin-right: 8px;"></i> Deposit
            </button>
            <button class="withdraw-btn" onclick="showWithdrawModal()">
                <i class='bx bx-money-withdraw' style="margin-right: 8px;"></i> Withdraw
            </button>
        </div>

        <div class="services">
            <button onclick="buySellGiftCard()">
                <i class='bx bxs-gift' style="margin-right: 8px;"></i> Buy/Sell Gift Card
            </button>
            <button onclick="tradeCrypto()">
                <i class='bx bxs-coin-stack' style="margin-right: 8px;"></i> Trade Crypto to Fiat
            </button>
            <button onclick="claimTokenizedRewards()">
                <i class='bx bxs-award' style="margin-right: 8px;"></i> Claim Tokenized Rewards
            </button>
            <button onclick="buyDataAirtime()">
                <i class='bx bx-wifi' style="margin-right: 8px;"></i> Buy Data/Airtime
            </button>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1" role="dialog" aria-labelledby="depositModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="depositModalLabel">Deposit Funds</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="depositForm">
                        <div class="form-group">
                            <label for="depositAmount">Amount ($)</label>
                            <input type="number" class="form-control" id="depositAmount" placeholder="Enter amount"
                                min="10" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="depositEmail">Email</label>
                            <input type="email" class="form-control" id="depositEmail" placeholder="Your email"
                                required>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" onclick="initiateDeposit()">Proceed to
                            Payment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" role="dialog" aria-labelledby="withdrawModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="withdrawModalLabel">Withdraw Funds</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="form-group">
                            <label for="withdrawAmount">Amount ($)</label>
                            <input type="number" class="form-control" id="withdrawAmount" placeholder="Enter amount"
                                min="10" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="withdrawMethod">Withdrawal Method</label>
                            <select class="form-control" id="withdrawMethod" required>
                                <option value="">Select method</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="paypal">PayPal</option>
                                <option value="crypto">Crypto Wallet</option>
                                <option value="cashapp">Cash App</option>
                            </select>
                        </div>
                        <div class="form-group" id="accountDetailsGroup" style="display: none;">
                            <label for="accountDetails">Account Details</label>
                            <input type="text" class="form-control" id="accountDetails"
                                placeholder="Enter account details">
                        </div>
                        <button type="button" class="btn btn-primary mt-3" onclick="processWithdrawal()">Submit
                            Withdrawal Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Crypto Trade Modal -->
    <div class="modal fade" id="cryptoModal" tabindex="-1" role="dialog" aria-labelledby="cryptoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cryptoModalLabel">Trade Crypto to Fiat</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="cryptoForm">
                        <div class="form-group">
                            <label for="cryptoType">Crypto Type</label>
                            <select class="form-control" id="cryptoType" required>
                                <option value="">Select cryptocurrency</option>
                                <option value="bitcoin">Bitcoin (BTC)</option>
                                <option value="ethereum">Ethereum (ETH)</option>
                                <option value="usdt">Tether (USDT)</option>
                                <option value="bnb">Binance Coin (BNB)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cryptoAmount">Amount (in crypto)</label>
                            <input type="number" class="form-control" id="cryptoAmount" placeholder="Enter amount"
                                min="0.0001" step="0.0001" required>
                        </div>
                        <div class="form-group">
                            <label for="walletAddress">Your Wallet Address</label>
                            <input type="text" class="form-control" id="walletAddress"
                                placeholder="Enter your wallet address" required>
                        </div>
                        <div class="form-group">
                            <label for="fiatAmount">You will receive (USD)</label>
                            <input type="text" class="form-control" id="fiatAmount" placeholder="Calculated amount"
                                readonly>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" onclick="processCryptoTrade()">Submit
                            Trade</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Rewards Modal -->
    <div class="modal fade" id="rewardsModal" tabindex="-1" role="dialog" aria-labelledby="rewardsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rewardsModalLabel">Claim Tokenized Rewards</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="rewardsInfo" style="margin-bottom: 20px;">
                        <h6>Available Rewards</h6>
                        <div class="alert alert-success">
                            <strong>Total Rewards:</strong> <span id="totalRewards">0</span> MW Tokens
                        </div>
                        <div class="alert alert-info">
                            <strong>Exchange Rate:</strong> 1 MW Token = $0.10
                        </div>
                    </div>
                    <form id="rewardsForm">
                        <div class="form-group">
                            <label for="claimAmount">Amount to Claim (MW Tokens)</label>
                            <input type="number" class="form-control" id="claimAmount" placeholder="Enter amount"
                                min="1" step="1" required>
                        </div>
                        <div class="form-group">
                            <label for="claimOption">Claim Option</label>
                            <select class="form-control" id="claimOption" required>
                                <option value="">Select option</option>
                                <option value="wallet">Deposit to Wallet ($)</option>
                                <option value="crypto">Convert to Crypto</option>
                            </select>
                        </div>
                        <div id="cryptoOptionGroup" style="display: none;">
                            <div class="form-group">
                                <label for="rewardsCryptoType">Crypto Type</label>
                                <select class="form-control" id="rewardsCryptoType">
                                    <option value="bitcoin">Bitcoin (BTC)</option>
                                    <option value="ethereum">Ethereum (ETH)</option>
                                    <option value="usdt">Tether (USDT)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rewardsWalletAddress">Wallet Address</label>
                                <input type="text" class="form-control" id="rewardsWalletAddress"
                                    placeholder="Enter wallet address">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" onclick="processRewardsClaim()">Claim
                            Rewards</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Verification Modal -->
    <div class="modal fade" id="verifyModal" tabindex="-1" role="dialog" aria-labelledby="verifyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="verifyModalLabel">Verify Deposit</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="verifyForm">
                        <div class="form-group">
                            <label for="transactionId">Transaction ID</label>
                            <input type="text" class="form-control" id="transactionId"
                                placeholder="Enter transaction ID from payment" required>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" onclick="verifyDeposit()">Verify
                            Deposit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal fade alert-modal" id="alertModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalTitle">Alert</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert-icon" id="alertIcon">
                        <i class='bx bx-info-circle'></i>
                    </div>
                    <p id="alertMessage">This is an alert message.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade alert-modal" id="confirmModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Confirm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert-icon" id="confirmIcon">
                        <i class='bx bx-question-mark'></i>
                    </div>
                    <p id="confirmMessage">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <section class="manage">
        <div class="bottom-navigation">
            <a href="/cashapp.html">
                <div class="nav-item-manage">
                    <i class='bx bxs-dollar-circle'></i>
                    <span>Cash App</span>
                </div>
            </a>

            <a href="/zelle.html">
                <div class="nav-item-manage">
                    <i class='bx bx-paper-plane'></i>
                    <span>Zelle</span>
                </div>
            </a>

            <a href="/manage.html" class="active">
                <div class="nav-item-manage">
                    <i class='bx bxs-home'></i>
                    <span>Home</span>
                </div>
            </a>
            <a href="/giftcard.html">
                <div class="nav-item-manage">
                    <i class='bx bxs-gift'></i>
                    <span>Giftcards</span>
                </div>
            </a>
            <a href="/settings.html">
                <div class="nav-item-manage">
                    <i class='bx bxs-cog'></i>
                    <span>Settings</span>
                </div>
            </a>
        </div>
    </section>

    <!-- Loading spinner (initially hidden) -->
    <div id="loading-spinner"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div class="spinner-border text-light" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
    <!-- Paystack Integration -->
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { increment as firebaseIncrement } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCB6Qi6NkuRPMcU5utI5UDHaKME81wVsCk",
            authDomain: "midepay-70db6.firebaseapp.com",
            databaseURL: "https://midepay-70db6-default-rtdb.firebaseio.com",
            projectId: "midepay-70db6",
            storageBucket: "midepay-70db6.firebasestorage.app",
            messagingSenderId: "1084919342118",
            appId: "1:1084919342118:web:0a724b3966226786e3b2e7",
            measurementId: "G-8MYZJX70RW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Global variables
        let currentUser = null;
        let currentDepositAmount = 0;
        let cryptoExchangeRates = {
            bitcoin: 50000, // 1 BTC = $50,000
            ethereum: 3000, // 1 ETH = $3,000
            usdt: 1,       // 1 USDT = $1
            bnb: 400       // 1 BNB = $400
        };

        // Custom alert functions
        function showAlert(title, message, type = 'info') {
            const iconMap = {
                'success': 'bx-check-circle success-icon',
                'error': 'bx-x-circle error-icon',
                'warning': 'bx-error warning-icon',
                'info': 'bx-info-circle info-icon'
            };
            
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            
            const iconElement = document.getElementById('alertIcon');
            iconElement.innerHTML = `<i class='bx ${iconMap[type]}'></i>`;
            
            $('#alertModal').modal('show');
        }

        function showConfirm(title, message, callback, type = 'warning') {
            const iconMap = {
                'success': 'bx-check-circle success-icon',
                'error': 'bx-x-circle error-icon',
                'warning': 'bx-error warning-icon',
                'info': 'bx-info-circle info-icon'
            };
            
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const iconElement = document.getElementById('confirmIcon');
            iconElement.innerHTML = `<i class='bx ${iconMap[type]}'></i>`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = callback;
            
            $('#confirmModal').modal('show');
        }

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                document.getElementById('username').textContent = user.displayName || 'User';
                document.getElementById('depositEmail').value = user.email || '';

                // Load user data
                const userRef = ref(database, 'users/' + user.uid);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        document.getElementById('balance').textContent = data.balance?.toFixed(2) || '0.00';
                        document.getElementById('totalRewards').textContent = data.rewards?.toFixed(2) || '0';
                    }
                });

                // Log page view
                logEvent(analytics, 'page_view', {
                    page_title: 'Dashboard',
                    page_location: window.location.href
                });
            } else {
                // User is signed out
                showAlert('Session Expired', 'Please login again to continue', 'warning');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
            }
        });

        // Show deposit modal
        window.showDepositModal = function () {
            logEvent(analytics, 'view_deposit_modal');
            $('#depositModal').modal('show');
        };

        // Show withdraw modal
        window.showWithdrawModal = function () {
            logEvent(analytics, 'view_withdraw_modal');
            $('#withdrawModal').modal('show');
        };

        // Show crypto trade modal
        window.tradeCrypto = function () {
            logEvent(analytics, 'view_crypto_modal');
            $('#cryptoModal').modal('show');

            // Set up real-time calculation for crypto to fiat conversion
            document.getElementById('cryptoAmount').addEventListener('input', function () {
                const cryptoType = document.getElementById('cryptoType').value;
                const amount = parseFloat(this.value) || 0;

                if (cryptoType && cryptoExchangeRates[cryptoType]) {
                    const fiatAmount = amount * cryptoExchangeRates[cryptoType];
                    document.getElementById('fiatAmount').value = fiatAmount.toFixed(2);
                } else {
                    document.getElementById('fiatAmount').value = '';
                }
            });

            document.getElementById('cryptoType').addEventListener('change', function () {
                const amount = parseFloat(document.getElementById('cryptoAmount').value) || 0;
                if (this.value && cryptoExchangeRates[this.value]) {
                    const fiatAmount = amount * cryptoExchangeRates[this.value];
                    document.getElementById('fiatAmount').value = fiatAmount.toFixed(2);
                } else {
                    document.getElementById('fiatAmount').value = '';
                }
            });
        };

        // Show rewards modal
        window.claimTokenizedRewards = function () {
            logEvent(analytics, 'view_rewards_modal');
            $('#rewardsModal').modal('show');

            // Show/hide crypto options based on claim option
            document.getElementById('claimOption').addEventListener('change', function () {
                const cryptoOptionGroup = document.getElementById('cryptoOptionGroup');
                if (this.value === 'crypto') {
                    cryptoOptionGroup.style.display = 'block';
                } else {
                    cryptoOptionGroup.style.display = 'none';
                }
            });
        };

        // Toggle account details field based on withdrawal method
        document.getElementById('withdrawMethod').addEventListener('change', function () {
            const accountDetailsGroup = document.getElementById('accountDetailsGroup');
            if (this.value) {
                accountDetailsGroup.style.display = 'block';
                // Update placeholder based on selected method
                const placeholderMap = {
                    'bank': 'Enter bank account details (Account Number, Bank Name)',
                    'paypal': 'Enter PayPal email address',
                    'crypto': 'Enter crypto wallet address',
                    'cashapp': 'Enter Cash App $tag'
                };
                document.getElementById('accountDetails').placeholder = placeholderMap[this.value] || 'Enter account details';
            } else {
                accountDetailsGroup.style.display = 'none';
            }
        });

        // Initiate deposit with Paystack
        window.initiateDeposit = function () {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const email = document.getElementById('depositEmail').value;

            if (!amount || amount < 10) {
                showAlert('Error', 'Minimum deposit amount is $10', 'error');
                return;
            }

            if (!email) {
                showAlert('Error', 'Please enter a valid email address', 'error');
                return;
            }

            currentDepositAmount = amount;

            // Convert USD to NGN (assuming 1 USD = 1500 NGN for example)
            const amountInKobo = Math.round(amount * 1500 * 100);

            // Initialize Paystack payment
            const handler = PaystackPop.setup({
                key: 'pk_test_48a80d3ce0116cd1ac78410703c172eb0880499a', // Replace with your Paystack public key
                email: email,
                amount: amountInKobo,
                currency: 'NGN',
                ref: 'MW' + Date.now(), // Generate a unique reference
                callback: function (response) {
                    // Payment successful, show verification modal
                    $('#depositModal').modal('hide');
                    $('#verifyModal').modal('show');
                    document.getElementById('transactionId').value = response.reference;

                    logEvent(analytics, 'deposit_initiated', {
                        amount: amount,
                        currency: 'USD'
                    });
                },
                onClose: function () {
                    // Payment window closed
                    showAlert('Info', 'Payment window was closed', 'info');
                }
            });

            handler.openIframe();
        };

        // Verify deposit with transaction ID
        window.verifyDeposit = async function() {
            const transactionId = document.getElementById('transactionId').value;
            
            if (!transactionId) {
                showAlert('Error', 'Please enter the transaction ID', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // Call your server endpoint to verify
                const response = await fetch('http://localhost:3000/verify-paystack', {
                    origin: 'http://localhost:3000',
                    method: ['POST','GET'],
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reference: transactionId })
                });

                // First check if the response is OK (status 200-299)
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                // Then try to parse the JSON
                const result = await response.json();
                
                if (result.success) {
                    // Update local balance display
                    const balanceElement = document.getElementById('balance');
                    const currentBalance = parseFloat(balanceElement.textContent) || 0;
                    const newBalance = currentBalance + (currentDepositAmount);
                    balanceElement.textContent = newBalance.toFixed(2);
                    
                    hideLoading();
                    $('#verifyModal').modal('hide');
                    
                    showAlert('Deposit Successful', `$${currentDepositAmount.toFixed(2)} has been added to your balance`, 'success');
                    
                    // Reset form
                    document.getElementById('depositForm').reset();
                    currentDepositAmount = 0;
                } else {
                    throw new Error(result.error || 'Transaction verification failed');
                }
            } catch (error) {
                hideLoading();
                showAlert('Verification Failed', error.message || 'Failed to verify transaction. Please try again.', 'error');
                console.error('Verification error:', error);
            }
        };

        // Show account details field when a withdrawal method is selected
        document.getElementById('withdrawMethod').addEventListener('change', function() {
            const accountDetailsGroup = document.getElementById('accountDetailsGroup');
            accountDetailsGroup.style.display = this.value ? 'block' : 'none';
            if (this.value) {
                document.getElementById('accountDetails').required = true;
            } else {
                document.getElementById('accountDetails').required = false;
            }
        });

        // Process withdrawal request
        window.processWithdrawal = function () {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const method = document.getElementById('withdrawMethod').value;
            const accountDetails = document.getElementById('accountDetails').value;

            if (!amount || amount < 10) {
                showAlert('Error', 'Minimum withdrawal amount is $10', 'error');
                return;
            }

            if (!method) {
                showAlert('Error', 'Please select a withdrawal method', 'error');
                return;
            }

            if (!accountDetails) {
                showAlert('Error', 'Please enter your account details', 'error');
                return;
            }

            showLoading();

            // Check if user has sufficient balance
            const currentBalance = parseFloat(document.getElementById('balance').textContent) || 0;
            if (amount > currentBalance) {
                hideLoading();
                showAlert('Error', 'Insufficient balance for this withdrawal', 'error');
                return;
            }

            // In a real app, you would process the withdrawal with your backend
            // For this example, we'll simulate a successful withdrawal request
            setTimeout(() => {
                hideLoading();
                $('#withdrawModal').modal('hide');

                // Update user balance in Firebase
                const userRef = ref(database, 'users/' + currentUser.uid);
                update(userRef, {
                    balance: increment(-amount)
                }).then(() => {
                    showAlert('Withdrawal Request Submitted', 
                        `Your withdrawal request of $${amount.toFixed(2)} via ${method} has been received.<br><br>
                        It will be processed within 24-48 hours.`, 'success');

                    logEvent(analytics, 'withdrawal_requested', {
                        amount: amount,
                        method: method
                    });

                    // Reset form
                    document.getElementById('withdrawForm').reset();
                    document.getElementById('accountDetailsGroup').style.display = 'none';
                }).catch((error) => {
                    showAlert('Error', 'Failed to process withdrawal. Please contact support.', 'error');
                    console.error('Error processing withdrawal:', error);
                });
            }, 2000);
        };

        // Process crypto trade
        window.processCryptoTrade = function () {
            const cryptoType = document.getElementById('cryptoType').value;
            const amount = parseFloat(document.getElementById('cryptoAmount').value);
            const walletAddress = document.getElementById('walletAddress').value;

            if (!cryptoType) {
                showAlert('Error', 'Please select a cryptocurrency', 'error');
                return;
            }

            if (!amount || amount <= 0) {
                showAlert('Error', 'Please enter a valid amount', 'error');
                return;
            }

            if (!walletAddress) {
                showAlert('Error', 'Please enter your wallet address', 'error');
                return;
            }

            showLoading();

            // Calculate fiat value
            const fiatValue = amount * cryptoExchangeRates[cryptoType];

            // In a real app, you would process the trade with your backend
            // For this example, we'll simulate a successful trade
            setTimeout(() => {
                hideLoading();
                $('#cryptoModal').modal('hide');

                showAlert('Trade Submitted', 
                    `You are trading ${amount} ${cryptoType.toUpperCase()} for $${fiatValue.toFixed(2)}.<br><br>
                    Our team will contact you shortly with payment details.`, 'success');

                logEvent(analytics, 'crypto_trade_submitted', {
                    crypto_type: cryptoType,
                    amount: amount,
                    fiat_value: fiatValue
                });

                // Reset form
                document.getElementById('cryptoForm').reset();
                document.getElementById('fiatAmount').value = '';
            }, 2000);
        };

        // Process rewards claim
        window.processRewardsClaim = function () {
            const claimAmount = parseInt(document.getElementById('claimAmount').value);
            const claimOption = document.getElementById('claimOption').value;

            if (!claimAmount || claimAmount <= 0) {
                showAlert('Error', 'Please enter a valid amount', 'error');
                return;
            }

            if (!claimOption) {
                showAlert('Error', 'Please select a claim option', 'error');
                return;
            }

            // Check if claiming to crypto wallet
            if (claimOption === 'crypto') {
                const walletAddress = document.getElementById('rewardsWalletAddress').value;
                if (!walletAddress) {
                    showAlert('Error', 'Please enter your wallet address', 'error');
                    return;
                }
            }

            showLoading();

            // Check available rewards
            const totalRewards = parseFloat(document.getElementById('totalRewards').textContent) || 0;
            if (claimAmount > totalRewards) {
                hideLoading();
                showAlert('Error', 'You don\'t have enough rewards to claim', 'error');
                return;
            }

            // In a real app, you would process the claim with your backend
            // For this example, we'll simulate a successful claim
            setTimeout(() => {
                hideLoading();
                $('#rewardsModal').modal('hide');

                // Calculate USD value (1 MW Token = $0.10)
                const usdValue = claimAmount * 0.1;

                // Update user data in Firebase
                const updates = {};
                updates['rewards'] = increment(-claimAmount);

                if (claimOption === 'wallet') {
                    updates['balance'] = increment(usdValue);
                }

                const userRef = ref(database, 'users/' + currentUser.uid);
                update(userRef, updates).then(() => {
                    let message = `You have successfully claimed ${claimAmount} MW Tokens.`;
                    if (claimOption === 'wallet') {
                        message += ` $${usdValue.toFixed(2)} has been added to your wallet balance.`;
                    } else {
                        message += ` Your crypto will be sent within 24 hours.`;
                    }

                    showAlert('Rewards Claimed', message, 'success');

                    logEvent(analytics, 'rewards_claimed', {
                        amount: claimAmount,
                        option: claimOption,
                        usd_value: usdValue
                    });

                    // Reset form
                    document.getElementById('rewardsForm').reset();
                    document.getElementById('cryptoOptionGroup').style.display = 'none';
                }).catch((error) => {
                    showAlert('Error', 'Failed to process rewards claim. Please contact support.', 'error');
                    console.error('Error processing rewards claim:', error);
                });
            }, 2000);
        };

        // Firebase increment function
        function increment(value) {
            return firebaseIncrement(value);
        }

        // Make other functions available globally
        window.buySellGiftCard = function () {
            showLoading();
            logEvent(analytics, 'select_content', {
                content_type: 'button',
                item_id: 'buy_sell_giftcard'
            });

            // Simulate API call
            setTimeout(() => {
                hideLoading();
                showConfirm('Gift Card Service', 
                    'You are being redirected to the gift card marketplace', 
                    () => {
                        window.location.href = '/giftcard.html';
                    }, 
                    'info');
            }, 1000);
        };

        window.buyDataAirtime = function () {
            showLoading();
            logEvent(analytics, 'select_content', {
                content_type: 'button',
                item_id: 'buy_data_airtime'
            });

            // Simulate API call
            setTimeout(() => {
                hideLoading();
                showConfirm('Data & Airtime', 
                    'You are being redirected to the data/airtime purchase page', 
                    () => {
                        window.location.href = '/data.html';
                    }, 
                    'info');
            }, 1000);
        };

        // Helper functions
        function showLoading() {
            document.getElementById('loading-spinner').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-spinner').style.display = 'none';
        }

        // Error handling
        window.addEventListener('error', (event) => {
            logEvent(analytics, 'exception', {
                description: event.message,
                fatal: true
            });

            showAlert('Error', 'An unexpected error occurred. Please try again later.', 'error');
        });
    </script>
</body>

</html>